app:
  description: "AIã‚³ãƒ¼ãƒãŒãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨˜éŒ²ã‚’èãã€è¤’ã‚ã¦ã€æ¬¡ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ææ¡ˆã¾ã§è¡Œã†ãƒãƒ£ãƒƒãƒˆãƒ•ãƒ­ãƒ¼ã€‚è¨˜éŒ²ãŒå«ã¾ã‚Œã‚‹å ´åˆã¯HTMLã‚³ãƒ¡ãƒ³ãƒˆã§JSONã‚’è¿”ã™ã€‚"
  icon: "ğŸƒ"
  icon_background: "#D1E9FF"
  mode: advanced-chat
  name: "AIã‚³ãƒ¼ãƒï¼ˆè¨˜éŒ²æŠ½å‡ºã¤ãï¼‰"
  use_icon_as_answer_icon: true
  kind: app
  version: 0.1.0

workflow:
  conversation_variables: []
  environment_variables: []
  features:
    file_upload:
      enabled: false
      image:
        enabled: false
      number_limits: 3
      transfer_methods:
        - local_file
        - remote_url
    opening_statement: "æ˜¨æ—¥ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã€ä½•ã‚’ã‚„ã£ãŸï¼Ÿï¼ˆä¾‹ï¼šãƒ©ãƒ³30åˆ† / ç­‹ãƒˆãƒ¬45åˆ† / ä¼‘é¤Š ãªã©ï¼‰"
    retriever_resource:
      enabled: false
    sensitive_word_avoidance:
      enabled: false
    speech_to_text:
      enabled: false
    suggested_questions:
      - "æ˜¨æ—¥ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å…¥åŠ›ã™ã‚‹"
      - "ä»Šæ—¥ã®ãŠã™ã™ã‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ï¼Ÿ"
      - "1é€±é–“ã®æŒ¯ã‚Šè¿”ã‚Šã‚’ã—ã¦"
    suggested_questions_after_answer:
      enabled: true
    text_to_speech:
      enabled: false
      language: ""
      voice: ""
  graph:
    edges:
      - data:
          isInIteration: false
          sourceType: start
          targetType: parameter-extractor
        id: start-source-pe-target
        source: "start"
        sourceHandle: source
        target: "pe"
        targetHandle: target
        type: custom
        zIndex: 0
      - data:
          isInIteration: false
          sourceType: parameter-extractor
          targetType: code
        id: pe-source-normalize-target
        source: "pe"
        sourceHandle: source
        target: "normalize"
        targetHandle: target
        type: custom
        zIndex: 0
      - data:
          isInIteration: false
          sourceType: code
          targetType: llm
        id: normalize-source-coach-target
        source: "normalize"
        sourceHandle: source
        target: "coach"
        targetHandle: target
        type: custom
        zIndex: 0
      - data:
          isInIteration: false
          sourceType: llm
          targetType: answer
        id: coach-source-answer-target
        source: "coach"
        sourceHandle: source
        target: "answer"
        targetHandle: target
        type: custom
        zIndex: 0

    nodes:
      - data:
          desc: ""
          selected: false
          title: "é–‹å§‹"
          type: start
          variables:
            - label: "ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆä»»æ„ï¼‰"
              max_length: 48
              options: []
              required: false
              type: text-input
              variable: user_name
            - label: "ç«¶æŠ€/ç¨®ç›®ï¼ˆä»»æ„ï¼‰"
              max_length: 64
              options: []
              required: false
              type: text-input
              variable: default_sport
            - label: "ç›®æ¨™ï¼ˆä»»æ„ï¼‰"
              max_length: 2048
              options: []
              required: false
              type: paragraph
              variable: goal
            - label: "éå»7æ—¥ã‚µãƒãƒªï¼ˆJSON, ä»»æ„ / Djangoã‹ã‚‰æ¸¡ã™æƒ³å®šï¼‰"
              max_length: 12000
              options: []
              required: false
              type: paragraph
              variable: stats_json
            - label: "ä»Šæ—¥ã®æ—¥ä»˜ï¼ˆYYYY-MM-DD, ä»»æ„ / Djangoã‹ã‚‰æ¸¡ã™æƒ³å®šï¼‰"
              max_length: 16
              options: []
              required: false
              type: text-input
              variable: today
          height: 190
        id: "start"
        position:
          x: 30
          y: 240
        positionAbsolute:
          x: 30
          y: 240
        sourcePosition: right
        targetPosition: left
        type: custom
        width: 320

      - data:
          desc: ""
          title: "å…¥åŠ›ã®æŠ½å‡ºï¼ˆintent/è¨˜éŒ²æƒ…å ±ï¼‰"
          type: parameter-extractor
          query:
            - sys
            - query
          instruction: |
            ã‚ãªãŸã¯ã‚¹ãƒãƒ¼ãƒ„ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨˜éŒ²å…¥åŠ›ã‚’è§£æã™ã‚‹æŠ½å‡ºå™¨ã§ã™ã€‚
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ï¼ˆæ—¥æœ¬èªï¼‰ã‹ã‚‰ã€æ¬¡ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã§ãã‚‹ã ã‘åŸ‹ã‚ã¦ãã ã•ã„ã€‚

            - intent:
              - log: è¨˜éŒ²ï¼ˆãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å†…å®¹/ä¼‘é¤Šã®å ±å‘Šï¼‰
              - plan: ãƒ¡ãƒ‹ãƒ¥ãƒ¼ææ¡ˆã®ä¾é ¼
              - analyse: 1é€±é–“ã®æŒ¯ã‚Šè¿”ã‚Š/è©•ä¾¡ã®ä¾é ¼
              - question: è³ªå•
              - other: ãã‚Œä»¥å¤–
            - date_hint: "yesterday" / "today" / "unknown" / ã‚‚ã—ãã¯ "YYYY-MM-DD"
              - ã€Œæ˜¨æ—¥ã€ã€Œãã®ã†ã€ã¯ yesterday
              - ã€Œä»Šæ—¥ã€ã¯ today
            - activity_type: "cardio" / "strength" / "skill" / "mobility" / "rest" / "other"
            - sport: ç¨®ç›®åï¼ˆä¾‹ï¼šãƒ©ãƒ³ã€ã‚¹ã‚¤ãƒ ã€ç­‹ãƒˆãƒ¬ã€ã‚µãƒƒã‚«ãƒ¼ç­‰ï¼‰
            - duration_min: åˆ†ï¼ˆæ•°å€¤ï¼‰
            - rpe: ä¸»è¦³å¼·åº¦ 1-10ï¼ˆæ•°å€¤ã€åˆ†ã‹ã‚‰ãªã‘ã‚Œã°ç©ºï¼‰
            - details: ãƒ•ãƒªãƒ¼ãƒ†ã‚­ã‚¹ãƒˆï¼ˆã‚»ãƒƒãƒˆæ•°ã€è·é›¢ã€å†…å®¹ãƒ¡ãƒ¢ãªã©ï¼‰
            - is_rest: ä¼‘é¤Š/ã‚ªãƒ•ãŒæ˜ç¤ºã•ã‚Œã¦ã„ã‚‹ãªã‚‰ true
          model:
            completion_params:
              temperature: 0
            mode: chat
            name: gpt-4o-mini
            provider: openai
          parameters:
            - name: intent
              type: string
              required: true
              description: "log|plan|analyse|question|other"
            - name: date_hint
              type: string
              required: false
              description: "yesterday|today|unknown|YYYY-MM-DD"
            - name: activity_type
              type: string
              required: false
              description: "cardio|strength|skill|mobility|rest|other"
            - name: sport
              type: string
              required: false
              description: "ç¨®ç›®å"
            - name: duration_min
              type: number
              required: false
              description: "åˆ†"
            - name: rpe
              type: number
              required: false
              description: "ä¸»è¦³å¼·åº¦1-10"
            - name: details
              type: string
              required: false
              description: "å†…å®¹ãƒ¡ãƒ¢"
            - name: is_rest
              type: boolean
              required: false
              description: "ä¼‘é¤Šãªã‚‰true"
        id: "pe"
        position:
          x: 390
          y: 240
        positionAbsolute:
          x: 390
          y: 240
        sourcePosition: right
        targetPosition: left
        type: custom
        width: 320
        height: 120

      - data:
          desc: ""
          title: "æ­£è¦åŒ– + LOG_PAYLOADç”Ÿæˆ"
          type: code
          code_language: python3
          variables:
            - variable: intent
              value_selector:
                - pe
                - intent
            - variable: date_hint
              value_selector:
                - pe
                - date_hint
            - variable: activity_type
              value_selector:
                - pe
                - activity_type
            - variable: sport
              value_selector:
                - pe
                - sport
            - variable: duration_min
              value_selector:
                - pe
                - duration_min
            - variable: rpe
              value_selector:
                - pe
                - rpe
            - variable: details
              value_selector:
                - pe
                - details
            - variable: is_rest
              value_selector:
                - pe
                - is_rest
            - variable: default_sport
              value_selector:
                - start
                - default_sport
            - variable: today
              value_selector:
                - start
                - today
            - variable: raw_user_input
              value_selector:
                - sys
                - query
          outputs:
            is_log:
              children: null
              type: boolean
            summary:
              children: null
              type: string
            log_json:
              children: null
              type: string
            payload_marker:
              children: null
              type: string
          code: |
            import json
            import re
            from datetime import datetime, timedelta

            def _safe_strip(x):
                if x is None:
                    return ""
                return str(x).strip()

            def _parse_today(today_str: str):
                s = _safe_strip(today_str)
                if not s:
                    return None
                try:
                    return datetime.strptime(s, "%Y-%m-%d").date()
                except Exception:
                    return None

            def _normalize_date(date_hint: str, today_str: str):
                dh = _safe_strip(date_hint).lower()
                if re.fullmatch(r"\d{4}-\d{2}-\d{2}", dh):
                    return dh
                today = _parse_today(today_str)
                if today is None:
                    return None
                if dh in ["yesterday", "æ˜¨æ—¥", "ãã®ã†"]:
                    return (today - timedelta(days=1)).strftime("%Y-%m-%d")
                if dh in ["today", "ä»Šæ—¥"]:
                    return today.strftime("%Y-%m-%d")
                # unknown -> assume yesterday because app asks about yesterday
                return (today - timedelta(days=1)).strftime("%Y-%m-%d")

            def main(intent, date_hint=None, activity_type=None, sport=None, duration_min=None, rpe=None, details=None,
                     is_rest=None, default_sport=None, today=None, raw_user_input=None):
                intent_s = _safe_strip(intent).lower()

                sport_s = _safe_strip(sport) or _safe_strip(default_sport)
                activity_s = _safe_strip(activity_type).lower()
                details_s = _safe_strip(details)

                # åˆ¤å®šï¼šè¨˜éŒ²ã‹ã©ã†ã‹ï¼ˆintent=log ã¾ãŸã¯ã€ãã‚Œã£ã½ã„æƒ…å ±ãŒã‚ã‚‹ï¼‰
                looks_like_log = (
                    intent_s == "log"
                    or bool(activity_s)
                    or (duration_min is not None)
                    or bool(details_s)
                    or bool(is_rest)
                    or (intent_s == "other" and any(k in _safe_strip(raw_user_input) for k in ["åˆ†", "km", "ã‚­ãƒ­", "ã‚»ãƒƒãƒˆ", "å›", "ä¼‘é¤Š", "ã‚ªãƒ•"]))
                )

                # æ—¥ä»˜ï¼ˆå¯èƒ½ãªã‚‰ISOã«ï¼‰
                log_date = _normalize_date(date_hint, today)

                if is_rest:
                    activity_s = "rest"

                # rpeæ•´å½¢
                rpe_v = None
                try:
                    if rpe is not None:
                        rpe_v = float(rpe)
                        if rpe_v.is_integer():
                            rpe_v = int(rpe_v)
                except Exception:
                    rpe_v = None

                # durationæ•´å½¢
                dur_v = None
                try:
                    if duration_min is not None:
                        dur_v = float(duration_min)
                        if dur_v.is_integer():
                            dur_v = int(dur_v)
                except Exception:
                    dur_v = None

                # ã¾ã¨ã‚ï¼ˆLLMã«æ¸¡ã™ç”¨ï¼‰
                parts = []
                if log_date:
                    parts.append(f"date={log_date}")
                if activity_s:
                    parts.append(f"type={activity_s}")
                if sport_s:
                    parts.append(f"sport={sport_s}")
                if dur_v is not None:
                    parts.append(f"duration_min={dur_v}")
                if rpe_v is not None:
                    parts.append(f"rpe={rpe_v}")
                if details_s:
                    parts.append(f"details={details_s}")
                summary = " / ".join(parts) if parts else ""

                log_json = ""
                payload_marker = ""

                if looks_like_log:
                    payload = {
                        "type": "training_log",
                        "date": log_date,
                        "activity_type": activity_s or None,
                        "sport": sport_s or None,
                        "duration_min": dur_v,
                        "rpe": rpe_v,
                        "details": details_s or None,
                        "raw_user_input": _safe_strip(raw_user_input) or None
                    }
                    log_json = json.dumps(payload, ensure_ascii=False)
                    payload_marker = f"<!--LOG_PAYLOAD {log_json} -->"

                return {
                    "is_log": bool(looks_like_log),
                    "summary": summary,
                    "log_json": log_json,
                    "payload_marker": payload_marker
                }
        id: "normalize"
        position:
          x: 750
          y: 240
        positionAbsolute:
          x: 750
          y: 240
        sourcePosition: right
        targetPosition: left
        type: custom
        width: 360
        height: 140

      - data:
          desc: ""
          title: "AIã‚³ãƒ¼ãƒ"
          type: llm
          context:
            enabled: false
            variable_selector: []
          memory:
            role_prefix:
              assistant: ""
              user: ""
            window:
              enabled: false
              size: 10
          model:
            completion_params:
              temperature: 0.7
              top_p: 0.9
            mode: chat
            name: gpt-4o
            provider: openai
          prompt_template:
            - id: "sys-coach"
              role: system
              text: |
                ã‚ãªãŸã¯ã€Œã‚¹ãƒãƒ¼ãƒ„AIã‚³ãƒ¼ãƒã€ã§ã™ã€‚å£èª¿ã¯ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ã§å‰å‘ãã€ã§ã‚‚ä¸­èº«ã¯å…·ä½“çš„ã«ã€‚

                ç›®çš„ï¼š
                - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç¶™ç¶šã§ãã‚‹ã‚ˆã†ã«ã€çŸ­ãè¤’ã‚ã‚‹ï¼ˆå…·ä½“ãƒã‚¤ãƒ³ãƒˆã‚’1ã€œ2å€‹ï¼‰
                - ãã®æ—¥ã®çŠ¶æ…‹ã«åˆã‚ã›ã¦ã€æ¬¡ã®ä¸€æ‰‹ï¼ˆä»Šæ—¥/æ˜æ—¥ï¼‰ã®ææ¡ˆã‚’2æ¡ˆå‡ºã™ï¼ˆè² è·é«˜/ä½ã®2æ¡ˆï¼‰
                - æœ€å¾Œã«è³ªå•ã‚’1ã¤ã ã‘ã—ã¦æ¬¡ã®å…¥åŠ›ã‚’ä¿ƒã™

                ãƒ«ãƒ¼ãƒ«ï¼š
                - åŒ»ç™‚è¡Œç‚ºã®æ–­å®šã¯ã—ãªã„ï¼ˆç—›ã¿ã‚„ä½“èª¿ä¸è‰¯ãŒå¼·ã„å ´åˆã¯ã€Œå°‚é–€å®¶ã«ç›¸è«‡ã‚‚æ¤œè¨ã€ç¨‹åº¦ï¼‰
                - æ–‡ç« ã¯é•·ã™ããªã„ï¼ˆç›®å®‰ï¼š6ã€œ12è¡Œï¼‰
                - çµµæ–‡å­—ã¯æ§ãˆã‚ï¼ˆ0ã€œ2å€‹ï¼‰
            - id: "usr-coach"
              role: user
              text: |
                ãƒ¦ãƒ¼ã‚¶ãƒ¼å: {{#start.user_name#}}
                ç›®æ¨™: {{#start.goal#}}
                éå»7æ—¥ã‚µãƒãƒª(JSON): {{#start.stats_json#}}
                ä»Šæ—¥(YYYY-MM-DD): {{#start.today#}}

                å…¥åŠ›ã¯è¨˜éŒ²ï¼Ÿ: {{#normalize.is_log#}}
                æŠ½å‡ºã•ã‚ŒãŸè¨˜éŒ²ã‚µãƒãƒª: {{#normalize.summary#}}

                ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›æœ¬æ–‡:
                {{#sys.query#}}

                æŒ‡ç¤ºï¼š
                - ã€Œå…¥åŠ›ã¯è¨˜éŒ²ï¼Ÿã€ãŒtrueãªã‚‰ã€è¨˜éŒ²å†…å®¹ã‚’è¸ã¾ãˆã¦è¤’ã‚ã‚‹â†’è»½ã„æŒ¯ã‚Šè¿”ã‚Šâ†’æ¬¡ã®ææ¡ˆ2æ¡ˆã€‚
                - falseãªã‚‰ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ï¼ˆè³ªå•/ææ¡ˆä¾é ¼/æŒ¯ã‚Šè¿”ã‚Šä¾é ¼ï¼‰ã«ç­”ãˆã¦ã‹ã‚‰ã€æ¬¡ã®ææ¡ˆ2æ¡ˆã€‚
                - æœ€å¾Œã«è³ªå•ã‚’1ã¤ã ã‘ã€‚
          vision:
            enabled: false
        id: "coach"
        position:
          x: 1150
          y: 240
        positionAbsolute:
          x: 1150
          y: 240
        sourcePosition: right
        targetPosition: left
        type: custom
        width: 360
        height: 120

      - data:
          desc: ""
          title: "è¿”ç­”"
          type: answer
          answer: |
            {{#coach.text#}}

            {{#normalize.payload_marker#}}
          variables: []
        id: "answer"
        position:
          x: 1550
          y: 240
        positionAbsolute:
          x: 1550
          y: 240
        sourcePosition: right
        targetPosition: left
        type: custom
        width: 320
        height: 120

  viewport:
    x: 50
    y: 50
    zoom: 0.7
